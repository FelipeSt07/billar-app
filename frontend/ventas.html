<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Billar App | Ventas</title>
<link rel="stylesheet" href="css/style.css">

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: linear-gradient(135deg, var(--negro), var(--rojo));
  height: 100vh;
}
.ventas-container { padding:30px }
h1 { margin-bottom:20px;
    color: #ffffffff }

.grid-wrapper { display:flex; justify-content:center }
.grid { display:grid; grid-template-columns:320px 420px; gap:25px }

.card {
  background:#fff;
  border-radius:14px;
  padding:20px;
  box-shadow:0 6px 20px rgba(0,0,0,.15);
}

.card h2 { color:#BF2000; margin-bottom:15px }

.mesa {
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
  cursor:pointer;
  border-left:6px solid #000;
  background:#fafafa;
}
.mesa.ocupada { border-color:#BF2000 }
.mesa.pausada { border-color:orange }
.mesa.seleccionada { background:#ffe9e4; font-weight:bold }

button {
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-size:14px;
  background:#BF2000;
  color:#fff;
  margin-top:6px;
}
button:hover { background:#9e1a00 }
.acciones button { background:#000 }

.info-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
}
.info-box {
  background:#f7f7f7;
  border-radius:10px;
  padding:12px;
  text-align:center;
}
.info-box span { font-size:13px; color:#666 }
.info-box strong { font-size:18px; display:block; margin-top:5px }

.productos-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:15px;
}
.producto {
  border:1px solid #ddd;
  border-radius:12px;
  padding:15px;
  text-align:center;
}
.producto button { background:#000 }
</style>
</head>

<body>

<div class="ventas-container">
<h1>üí∞ Ventas y Mesas</h1>

<div class="grid-wrapper">
<div class="grid">

<!-- MESAS -->
<div class="card">
<h2>Mesas</h2>
<div id="mesas"></div>
<div class="acciones">
<button onclick="iniciarMesa()">‚ñ∂ Iniciar</button>    
<button onclick="pausarMesa()">‚è∏ Pausar</button>
<button onclick="reanudarMesa()">üîÑ Reanudar</button>
<button onclick="finalizarMesa()">‚èπ Finalizar</button>
</div>
</div>

<!-- ESTADO -->
<div class="card">
<h2>Mesa actual</h2>
<div class="info-grid">
<div class="info-box"><span>Mesa</span><strong id="mesaActual">Ninguna</strong></div>
<div class="info-box"><span>Estado</span><strong id="estadoMesa">-</strong></div>
<div class="info-box"><span>Tiempo (min)</span><strong id="tiempo">0</strong></div>
<div class="info-box"><span>Precio / min</span><strong id="precioMin">$100</strong></div>
<div class="info-box"><span>Costo tiempo</span><strong id="costoTiempo">$0</strong></div>
<div class="info-box"><span>Total</span><strong id="totalVenta">$0</strong></div>
<div class="info-box">
  <span>Productos</span>
  <strong id="totalProductos">$0</strong>
</div>

</div>
</div>

</div>
</div>

<!-- PRODUCTOS -->
<div class="card" style="margin-top:25px">
<h2>Productos disponibles</h2>
<div class="productos-grid" id="productos"></div>
</div>

<pre id="resultado"></pre>
</div>

<script>
let mesaSeleccionada = null;
let idSesion = null;
let totalProductos = 0;
const precioMinuto = 100;
let timerInterval = null;
let horaInicioSesion = null;
let minutosActuales = 0;


/* ===================== UTIL ===================== */
function mostrar(d){
  document.getElementById("resultado").textContent =
    JSON.stringify(d, null, 2);
}

function iniciarReloj(horaInicio) {
  if (timerInterval) clearInterval(timerInterval);

  horaInicioSesion = new Date(horaInicio.replace(" ", "T"));

  timerInterval = setInterval(() => {
    const ahora = new Date();
    const diffMs = ahora - horaInicioSesion;

    const minutos = Math.floor(diffMs / 60000);
    document.getElementById("tiempo").textContent = minutos;

    const costoTiempo = minutos * precioMinuto;
    document.getElementById("costoTiempo").textContent = `$${costoTiempo}`;

    document.getElementById("totalVenta").textContent =
  `$${costoTiempo + totalProductos}`;
    // ‚ö†Ô∏è El total final lo veremos luego
  }, 1000);
}


/* ===================== MESAS ===================== */
function cargarMesas(){
  fetch("/billar-app/backend/mesas/estado.php")
    .then(r => r.json())
    .then(res => {
      const cont = document.getElementById("mesas");
      cont.innerHTML = "";

      res.data.forEach(m => {
        const div = document.createElement("div");
        div.className = `mesa ${m.estado}`;
        if (m.id_mesa === mesaSeleccionada) {
          div.classList.add("seleccionada");
        }

        div.innerHTML = `
          <strong>${m.nombre_mesa}</strong><br>
          <small>${m.estado}</small>
        `;

        div.onclick = () => seleccionarMesa(m.id_mesa);
        cont.appendChild(div);
      });
    });
}

/* ===================== SELECCIONAR MESA ===================== */
function seleccionarMesa(idMesa) {

  // üîÅ Si se selecciona la misma mesa, no hacer nada
  if (mesaSeleccionada === idMesa) return;

  // üõë Detener cualquier reloj activo
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }

  // üîÑ Actualizar mesa seleccionada
  mesaSeleccionada = idMesa;

  totalProductos = 0;
  idSesion = null;

  document.getElementById("mesaActual").textContent = `Mesa ${idMesa}`;

  // üßº Limpiar card derecha inmediatamente
  document.getElementById("estadoMesa").textContent = "-";
  document.getElementById("tiempo").textContent = "0";
  document.getElementById("costoTiempo").textContent = "$0";
  document.getElementById("totalProductos").textContent = "$0";
  document.getElementById("totalVenta").textContent = "$0";

  // üì° Consultar si la mesa tiene sesi√≥n activa
  fetch(`/billar-app/backend/sesiones/obtener.php?id_mesa=${idMesa}`)
    .then(r => r.json())
    .then(res => {

      if (res.success && res.data) {
        idSesion = res.data.id_sesion;

        document.getElementById("estadoMesa").textContent = res.data.estado;

  // üîÑ Cargar valores reales desde backend
        actualizarEstado();

        // ‚è± Iniciar reloj solo si la sesi√≥n est√° activa
        if (res.data.estado === "activa") {
          iniciarReloj(res.data.hora_inicio);
        }

        
      }else {
    // üßº Mesa sin sesi√≥n
    idSesion = null;
  }
    });

  // üîÑ Refrescar visual de mesas (seleccionada)
  cargarMesas();
}



function iniciarMesa(){
  if (!mesaSeleccionada) {
    alert("Seleccione una mesa");
    return;
  }

  fetch("/billar-app/backend/mesas/iniciar.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id_mesa: mesaSeleccionada })
  })
  .then(r => r.json())
  .then(d => {
  if (!d.success) {
    alert(d.message);
    return;
  }

  idSesion = d.id_sesion;

  // üî• INICIAR RELOJ REAL
  fetch(`/billar-app/backend/sesiones/actual.php?id_mesa=${mesaSeleccionada}`)
    .then(r => r.json())
    .then(res => {
      if (res.data?.hora_inicio) {
        iniciarReloj(res.data.hora_inicio);
        document.getElementById("estadoMesa").textContent = res.data.estado;
      }
    });

  cargarMesas();
  actualizarEstado();
    });
}

/* ===================== ESTADO / TIEMPO ===================== */
function actualizarEstado() {
  if (!mesaSeleccionada || !idSesion) return;

  fetch(`/billar-app/backend/sesiones/actual.php?id_mesa=${mesaSeleccionada}`)
    .then(r => r.json())
    .then(res => {
      if (!res.success || !res.data) return;

      const s = res.data;

      // ü™ë Estado
      document.getElementById("estadoMesa").textContent = s.estado;

      // ‚è± Tiempo (solo mostrar, no incrementar aqu√≠)
      minutosActuales = parseInt(s.minutos) || 0;
      document.getElementById("tiempo").textContent = minutosActuales;

      // üí∏ Costo por tiempo
      const costoTiempo = minutosActuales * precioMinuto;
      document.getElementById("costoTiempo").textContent = `$${costoTiempo}`;

      // üßæ Total productos (SIEMPRE desde backend)
      totalProductos = parseInt(s.total_productos) || 0;
      document.getElementById("totalProductos").textContent =
        `$${totalProductos}`;

      // üí∞ Total final
      document.getElementById("totalVenta").textContent =
        `$${costoTiempo + totalProductos}`;
    });
}


/* ===================== PRODUCTOS ===================== */
function cargarProductos(){
  fetch("/billar-app/backend/productos/listar.php")
    .then(r => r.json())
    .then(res => {
      const cont = document.getElementById("productos");
      cont.innerHTML = "";

      res.data.forEach(p => {
        const div = document.createElement("div");
        div.className = "producto";

        const sinStock = p.stock <= 0;

        div.innerHTML = `
          <h4>${p.nombre}</h4>
          <small>$${p.precio}</small>
          <small>
            Stock: 
            <strong style="color:${sinStock ? 'red' : 'black'}">
              ${p.stock}
            </strong>
          </small>
          <button 
            onclick="agregarProducto(${p.id_producto})"
            ${sinStock ? "disabled" : ""}
            style="${sinStock ? "opacity:.5; cursor:not-allowed;" : ""}"
          >
            ${sinStock ? "Sin stock" : "Agregar"}
          </button>
        `;

        cont.appendChild(div);
      });
    });
}


function agregarProducto(idProducto) {
  if (!mesaSeleccionada || !idSesion) {
    alert("Inicie una mesa primero");
    return;
  }

  fetch("/billar-app/backend/ventas/agregar_producto.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      id_sesion: idSesion,
      id_producto: idProducto,
      cantidad: 1
    })
  })
  .then(r => r.json())
  .then(d => {
    if (!d.success) {
      alert(d.message);
      return;
    }

    // üî• ACTUALIZACI√ìN INMEDIATA EN FRONTEND
    totalProductos += parseInt(d.subtotal);

    document.getElementById("totalProductos").textContent =
      `$${totalProductos}`;

    const minutos = parseInt(document.getElementById("tiempo").textContent) || 0;
    const costoTiempo = minutos * precioMinuto;

    document.getElementById("totalVenta").textContent =
      `$${costoTiempo + totalProductos}`;

     // üîÑ Refrescar estado y stock desde backend
    actualizarEstado();   // Actualiza total de productos y total final
    cargarProductos();    // Actualiza stock en la lista de productos
  });
}


/* ===================== ACCIONES ===================== */
function pausarMesa(){
  if (!mesaSeleccionada) return;

  fetch("/billar-app/backend/mesas/pausar.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id_mesa: mesaSeleccionada })
  })
  .then(r => r.json())
  .then(() => {
    cargarMesas();
    actualizarEstado();
  });
}

function reanudarMesa(){
  if (!mesaSeleccionada) return;

  fetch("/billar-app/backend/mesas/reanudar.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id_mesa: mesaSeleccionada })
  })
  .then(r => r.json())
  .then(() => {
    cargarMesas();
    actualizarEstado();
  });
}

function finalizarMesa(){
  if (!idSesion) return alert("No hay sesi√≥n activa");

  fetch("/billar-app/backend/mesas/finalizar.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id_mesa: mesaSeleccionada })
  })
  .then(r => r.json())
  .then(() => {

    // üõë DETENER RELOJ
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }

    mesaSeleccionada = null;
    idSesion = null;
    totalProductos = 0;

    document.getElementById("mesaActual").textContent = "Ninguna";
    document.getElementById("estadoMesa").textContent = "-";
    document.getElementById("tiempo").textContent = "0";
    document.getElementById("costoTiempo").textContent = "$0";
    document.getElementById("totalVenta").textContent = "$0";
    document.getElementById("totalProductos").textContent = "$0";

    cargarMesas();
  });
}

/* ===================== INIT ===================== */
document.addEventListener("DOMContentLoaded", () => {
  cargarMesas();
  cargarProductos();
  setInterval(actualizarEstado, 30000);
});

</script>


</body>
</html>
